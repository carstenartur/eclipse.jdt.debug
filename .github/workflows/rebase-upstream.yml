name: Rebase on Upstream Master

on:
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  add-rebase-button:
    name: Add Rebase Instructions
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Add comment with rebase instructions
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `### üîÑ Rebase on Upstream Master
            
            To rebase this PR branch onto the latest \`eclipse-jdt/eclipse.jdt.debug:master\` (excluding fork-specific commits), comment:
            
            \`\`\`
            /rebase-upstream
            \`\`\`
            
            This will:
            1. Fetch the latest changes from \`eclipse-jdt/eclipse.jdt.debug:master\`
            2. Rebase **only your PR commits** onto upstream master (skipping fork-specific commits)
            3. Force push the rebased branch
            
            [View workflow runs](${context.payload.repository.html_url}/actions/workflows/rebase-upstream.yml)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  rebase-upstream:
    name: Rebase on Upstream Master
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '/rebase-upstream')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check if user is authorized
        id: check-auth
        uses: actions/github-script@v7
        with:
          script: |
            const author_association = context.payload.comment.author_association;
            const authorized = ['OWNER', 'MEMBER', 'COLLABORATOR'].includes(author_association);
            
            if (!authorized) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `@${context.payload.comment.user.login} ‚ùå Only repository owners, members, and collaborators can trigger the rebase.`
              });
              core.setFailed('User not authorized to trigger rebase');
            }
            
            return authorized;

      - name: Add rocket reaction to acknowledge command
        if: steps.check-auth.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR branch information
        if: steps.check-auth.outputs.result == 'true'
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            if (!pr.head.repo) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚ùå Cannot rebase: The source repository has been deleted. Please close and recreate this PR from an active fork.'
              });
              core.setFailed('Source repository has been deleted');
              return;
            }
            
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('head_sha', pr.head.sha);

      - name: Checkout PR branch
        if: steps.check-auth.outputs.result == 'true'
        uses: actions/checkout@v4
        with:
          # Security note: This checks out untrusted code, but is protected by:
          # 1. Authorization check (only OWNER/MEMBER/COLLABORATOR can trigger)
          # 2. No code from the PR is executed - only git operations are performed
          # 3. Similar security model to the existing rebase workflow in this repo
          repository: ${{ steps.pr-info.outputs.head_repo }}
          ref: ${{ steps.pr-info.outputs.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        if: steps.check-auth.outputs.result == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and rebase
        if: steps.check-auth.outputs.result == 'true'
        id: rebase
        run: |
          # Disable automatic exit on error to manually handle rebase failures
          set +e
          git remote add upstream https://github.com/eclipse-jdt/eclipse.jdt.debug.git
          git fetch upstream master
          git fetch origin master
          
          # Find the merge-base between current branch and origin/master
          FORK_POINT=$(git merge-base HEAD origin/master)
          echo "Fork point: $FORK_POINT"
          
          # Get current branch name
          CURRENT_BRANCH=$(git branch --show-current)
          echo "Current branch: $CURRENT_BRANCH"
          
          echo "Rebasing only PR commits onto upstream/master..."
          # Use --onto to rebase only commits after the fork point
          # This excludes fork-specific commits that are in origin/master
          git rebase --onto upstream/master "$FORK_POINT" "$CURRENT_BRANCH"
          REBASE_EXIT_CODE=$?
          
          if [ $REBASE_EXIT_CODE -ne 0 ]; then
            echo "rebase_failed=true" >> $GITHUB_OUTPUT
            git rebase --abort || true
            exit 1
          fi
          
          echo "rebase_failed=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Force push with lease
        if: steps.check-auth.outputs.result == 'true' && steps.rebase.outputs.rebase_failed != 'true'
        id: push
        run: |
          # Note: GITHUB_TOKEN has write access to the fork if the PR author has enabled
          # "Allow edits by maintainers" (enabled by default for most PRs)
          # Disable automatic exit on error to manually handle push failures
          set +e
          git push --force-with-lease origin ${{ steps.pr-info.outputs.head_ref }}
          PUSH_EXIT_CODE=$?
          
          if [ $PUSH_EXIT_CODE -ne 0 ]; then
            echo "push_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "push_failed=false" >> $GITHUB_OUTPUT
          exit 0

      - name: Add success comment and reaction
        if: steps.check-auth.outputs.result == 'true' && steps.rebase.outputs.rebase_failed != 'true' && steps.push.outputs.push_failed != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Successfully rebased onto `eclipse-jdt/eclipse.jdt.debug:master`'
            });

      - name: Add rebase failure comment and reaction
        if: steps.check-auth.outputs.result == 'true' && failure() && steps.rebase.outputs.rebase_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
            
            const comment = `‚ùå Rebase failed due to conflicts.
            
            To rebase manually:
            \`\`\`bash
            git remote add upstream https://github.com/eclipse-jdt/eclipse.jdt.debug.git
            git fetch upstream master
            git fetch origin master
            
            # Find the fork point (where your branch diverged from origin/master)
            FORK_POINT=$(git merge-base HEAD origin/master)
            
            # Rebase only your PR commits onto upstream/master (excluding fork commits)
            # The third argument (HEAD) specifies to rebase everything from FORK_POINT to HEAD
            git rebase --onto upstream/master $FORK_POINT HEAD
            
            # Resolve conflicts if any
            git rebase --continue
            
            git push --force-with-lease
            \`\`\``;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Add push failure comment and reaction
        if: steps.check-auth.outputs.result == 'true' && failure() && steps.push.outputs.push_failed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '-1'
            });
            
            const comment = `‚ùå Rebase succeeded but push failed due to insufficient permissions.
            
            **Possible causes:**
            - The PR author has not enabled "Allow edits by maintainers"
            - The fork repository has restricted push access
            
            **To enable automatic rebase:**
            1. Go to the PR page
            2. Check "Allow edits by maintainers" in the sidebar
            3. Try the \`/rebase-upstream\` command again
            
            **Or rebase manually:**
            \`\`\`bash
            git remote add upstream https://github.com/eclipse-jdt/eclipse.jdt.debug.git
            git fetch upstream master
            git fetch origin master
            
            # Find the fork point (where your branch diverged from origin/master)
            FORK_POINT=$(git merge-base HEAD origin/master)
            
            # Rebase only your PR commits onto upstream/master (excluding fork commits)
            # The third argument (HEAD) specifies to rebase everything from FORK_POINT to HEAD
            git rebase --onto upstream/master $FORK_POINT HEAD
            
            git push --force-with-lease
            \`\`\``;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
